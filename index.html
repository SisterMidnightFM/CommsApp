<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMFM Instagram Comms App V2.0</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="favicon.png" type="image/x-icon">
</head>
<body>
    <!-- Main header -->
    <header>
        SMFM Instagram Comms App V2.0
    </header>

    <!-- App container with split layout -->
    <div class="app-container">
        <!-- Left side: Controls panel -->
        <div class="controls-panel">
            <!-- Stage 1: Upload Image -->
            <div class="stage" id="stage1">
                <div class="stage-title">Stage 1: Upload Image</div>
                <input type="file" id="imageUpload" accept="image/*">
                <p>Image will be automatically resized to 1080px Ã— 1350px - 4:5 aspect ratio </p>
            </div>

            <!-- Add buttons for selecting template color -->
            <div class="stage" id="stageTemplate">
                <div class="stage-title">Select Template Colour</div>
                <button id="whiteTemplateBtn">White</button>
                <button id="blackTemplateBtn">Black</button>
            </div>
            
            <!-- Stage 2: Adjust Image -->
            <div class="stage" id="stage2">
                <div class="stage-title">Stage 2: Adjust Image</div>
                <label for="zoomSlider">Zoom: <span id="zoomValue" class="range-value">0%</span></label>
                <input type="range" id="zoomSlider" min="-50" max="150" value="0">
                
                <label for="xPosSlider">X Position: <span id="xPosValue" class="range-value">0</span></label>
                <input type="range" id="xPosSlider" min="-100" max="100" value="0">
                
                <label for="yPosSlider">Y Position: <span id="yPosValue" class="range-value">0</span></label>
                <input type="range" id="yPosSlider" min="-100" max="100" value="0">
                
                <p><small>Tip: You can also click and drag directly on the image to adjust position</small></p>
            </div>

            <!-- Stage 3: Add Text -->
            <div class="stage" id="stage3">
                <div class="stage-title">Stage 3: Add Name and Date</div>
                <label for="showName">Show Name:</label>
                <input type="text" id="showName" placeholder="Enter show name">
                
                <label for="showDate">Show Date:</label>
                <input type="datetime-local" id="showDate">
                
                <label for="textSizeSlider">Text Size: <span id="textSizeValue" class="range-value">33pt</span></label>
                <input type="range" id="textSizeSlider" min="10" max="50" value="33">
                
                <label for="tag1">Tag 1 (max 20 characters):</label>
                <input type="text" id="tag1" placeholder="Enter first tag" maxlength="15">
                
                <label for="tag2">Tag 2 (max 20 characters):</label>
                <input type="text" id="tag2" placeholder="Enter second tag" maxlength="15">
            </div>

            <!-- Stage 4: Export -->
            <div class="stage" id="stage4">
                <div class="stage-title">Stage 4: Export</div>
                <label for="fileName">File Name:</label>
                <input type="text" id="fileName" readonly>
                <button id="exportBtn">Export Image</button>
                <p id="exportStatus"></p>
            </div>
        </div>

        <!-- Right side: Preview panel -->
        <div class="preview-panel">
            <div class="canvas-container">
                <canvas id="previewCanvas"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        const canvas = document.getElementById('previewCanvas');
        const ctx = canvas.getContext('2d');
        
        // Standard Instagram size
        const CANVAS_WIDTH = 1080;
        const CANVAS_HEIGHT = 1350;
        
        // Set initial canvas dimensions
        canvas.width = CANVAS_WIDTH;
        canvas.height = CANVAS_HEIGHT;
        
        // Image holders
        let userImage = null;
        let templateImage = null;
        
        // Current settings
        const settings = {
            zoom: 0,
            xPos: 0,
            yPos: 0,
            showName: '',
            showDate: '',
            textSize: 33, // Default text size
            fontColor: 'white', // Default font color
            tag1: '',
            tag2: ''
        };

        // Set initial datetime value to current date and time
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        document.getElementById('showDate').value = `${year}-${month}-${day}T${hours}:${minutes}`;

        // Load template image on startup
        loadTemplateImage('template_white.png');

        // STAGE 1: Image Upload logic
        document.getElementById('imageUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    loadUserImage(event.target.result);
                };
                reader.readAsDataURL(file);
            }
        });

        // STAGE 2: Adjust image logic
        document.getElementById('zoomSlider').addEventListener('input', function(e) {
            settings.zoom = parseInt(e.target.value);
            document.getElementById('zoomValue').textContent = settings.zoom + '%';
            redrawCanvas();
        });

        document.getElementById('xPosSlider').addEventListener('input', function(e) {
            settings.xPos = parseInt(e.target.value);
            document.getElementById('xPosValue').textContent = settings.xPos;
            redrawCanvas();
        });

        document.getElementById('yPosSlider').addEventListener('input', function(e) {
            settings.yPos = parseInt(e.target.value);
            document.getElementById('yPosValue').textContent = settings.yPos;
            redrawCanvas();
        });

        // STAGE 3: Text input logic
        document.getElementById('showName').addEventListener('input', function(e) {
            settings.showName = e.target.value;
            updateFileName();
            redrawCanvas();
        });

        document.getElementById('showDate').addEventListener('change', function(e) {
            // Format the date for display
            const date = new Date(e.target.value);
            const options = { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            settings.showDate = date.toLocaleDateString('en-US', options);
            updateFileName();
            redrawCanvas();
        });

        // Text size slider
        document.getElementById('textSizeSlider').addEventListener('input', function(e) {
            settings.textSize = parseInt(e.target.value);
            document.getElementById('textSizeValue').textContent = settings.textSize + 'pt';
            redrawCanvas();
        });

        // Tag input logic
        document.getElementById('tag1').addEventListener('input', function(e) {
            settings.tag1 = e.target.value;
            redrawCanvas();
        });

        document.getElementById('tag2').addEventListener('input', function(e) {
            settings.tag2 = e.target.value;
            redrawCanvas();
        });

        // STAGE 4: Export logic
        document.getElementById('exportBtn').addEventListener('click', function() {
            try {
                // Create a download link for the canvas content
                const exportStatus = document.getElementById('exportStatus');
                exportStatus.textContent = "Preparing download...";
                
                // Make sure template is loaded
                if (!templateImage || !templateImage.complete) {
                    exportStatus.textContent = "Error: Template image not loaded. Try again.";
                    return;
                }
                
                const fileName = document.getElementById('fileName').value || "image";
                const link = document.createElement('a');
                link.download = fileName + '.png';
                
                // Use timeout to ensure UI updates before heavy processing
                setTimeout(() => {
                    try {
                        // Get canvas data and trigger download
                        link.href = canvas.toDataURL('image/png');
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        exportStatus.textContent = "Download complete!";
                        
                        // Clear status message after 3 seconds
                        setTimeout(() => {
                            exportStatus.textContent = "";
                        }, 3000);
                    } catch (err) {
                        console.error("Export error:", err);
                        exportStatus.textContent = "Error exporting: " + err.message;
                    }
                }, 100);
            } catch (err) {
                console.error("Export setup error:", err);
                document.getElementById('exportStatus').textContent = "Error setting up export: " + err.message;
            }
        });

        // Add event listeners for template selection buttons
        document.getElementById('whiteTemplateBtn').addEventListener('click', function() {
            loadTemplateImage('template_white.png');
            settings.fontColor = 'white'; // Set font color to white
            redrawCanvas(); // Redraw the canvas with the updated font color
        });

        document.getElementById('blackTemplateBtn').addEventListener('click', function() {
            loadTemplateImage('template_black.png');
            settings.fontColor = 'black'; // Set font color to black
            redrawCanvas(); // Redraw the canvas with the updated font color
        });

        // Function to load the template image
        function loadTemplateImage(templateSrc) {
            templateImage = new Image();
            templateImage.onload = function() {
                redrawCanvas();
            };
            templateImage.src = templateSrc;
            templateImage.onerror = function(e) {
                console.error('Error loading template image:', e);
                alert(`Could not load the template image: ${templateSrc}. Make sure it exists in the app folder.`);
            };
        }

        // Function to load and process user image
        function loadUserImage(src) {
            // Create a new image object
            const img = new Image();
            img.onload = function() {
                userImage = img;
                
                // Reset sliders when new image is loaded
                document.getElementById('zoomSlider').value = 0;
                document.getElementById('zoomValue').textContent = '0%';
                document.getElementById('xPosSlider').value = 0;
                document.getElementById('xPosValue').textContent = '0';
                document.getElementById('yPosSlider').value = 0;
                document.getElementById('yPosValue').textContent = '0';
                
                // Reset settings
                settings.zoom = 0;
                settings.xPos = 0;
                settings.yPos = 0;
                
                // Calculate initial zoom to fit entire image
                calculateInitialZoom();
                
                // Redraw canvas with new image
                redrawCanvas();
            };
            img.src = src;
        }
        
        // Calculate initial zoom to fit the entire image within canvas
        function calculateInitialZoom() {
            if (!userImage) return;
            
            // Get aspect ratios
            const imageRatio = userImage.width / userImage.height;
            const canvasRatio = CANVAS_WIDTH / CANVAS_HEIGHT;
            
            // Calculate scale factor to fit entire image
            let scaleFactor;
            if (imageRatio > canvasRatio) {
                // Image is wider than canvas ratio
                scaleFactor = CANVAS_WIDTH / userImage.width;
            } else {
                // Image is taller than canvas ratio
                scaleFactor = CANVAS_HEIGHT / userImage.height;
            }
            
            // Scale down slightly to ensure full visibility (90% of fitting size)
            scaleFactor *= 0.9;
            
            // Convert to percentage zoom (100% is original size)
            const initialZoom = (scaleFactor * 100) - 100;
            
            // Update zoom slider
            const zoomSlider = document.getElementById('zoomSlider');
            zoomSlider.value = initialZoom;
            document.getElementById('zoomValue').textContent = Math.round(initialZoom) + '%';
            settings.zoom = Math.round(initialZoom);
        }

        // Function to update the file name based on show name and date
        function updateFileName() {
            // Get date info from the date picker
            let dateStr = "";
            if (document.getElementById('showDate').value) {
                const date = new Date(document.getElementById('showDate').value);
                dateStr = date.toISOString().split('T')[0]; // Use YYYY-MM-DD format
            }
            
            // Replace spaces and special characters with underscores
            const sanitizedName = settings.showName.replace(/[^a-zA-Z0-9]/g, '_');
            const sanitizedDate = dateStr.replace(/[^a-zA-Z0-9]/g, '_');
            
            // Combine name and date for filename
            const fileName = sanitizedName + '_' + sanitizedDate;
            document.getElementById('fileName').value = fileName;
        }

        // Function to draw a tag box with text
        function drawTagBox(text, x, y) {
            if (!text) return;

            // Set font for measuring text
            ctx.font = '24pt Font2'; // Ensure this matches the rendering font

            // Measure the transformed text
            const transformedText = text.toUpperCase();
            const metrics = ctx.measureText(transformedText);
            const textWidth = metrics.width + 5; // Add a buffer of 10 pixels
            const textHeight = 24; // Approximate height in points

            // Box padding
            const paddingX = 20;
            const paddingY = 12;

            // Calculate box dimensions
            const boxWidth = textWidth + paddingX * 2;
            const boxHeight = textHeight + paddingY * 2;

            // Draw the box border
            ctx.strokeStyle = settings.fontColor || 'white';
            ctx.lineWidth = 3;
            ctx.strokeRect(x, y - boxHeight / 2, boxWidth, boxHeight);

            // Draw the text
            ctx.fillStyle = settings.fontColor || 'white';
            ctx.textAlign = 'left';
            ctx.textBaseline = 'middle';
            ctx.fillText(transformedText, x + paddingX, y);
        }

        // Main function to redraw the canvas with all current settings
        function redrawCanvas() {
            // Clear the canvas
            ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

            // Background fill (in case image doesn't cover canvas)
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

            // Draw user image if available
            if (userImage) {
                const zoomFactor = 1 + (settings.zoom / 100);
                const imgWidth = userImage.width;
                const imgHeight = userImage.height;
                let drawWidth, drawHeight;
                const canvasRatio = CANVAS_WIDTH / CANVAS_HEIGHT;
                const imgRatio = imgWidth / imgHeight;

                if (imgRatio > canvasRatio) {
                    drawWidth = CANVAS_WIDTH * zoomFactor;
                    drawHeight = drawWidth / imgRatio;
                } else {
                    drawHeight = CANVAS_HEIGHT * zoomFactor;
                    drawWidth = drawHeight * imgRatio;
                }

                const xOffset = (CANVAS_WIDTH - drawWidth) / 2 + settings.xPos * 5;
                const yOffset = (CANVAS_HEIGHT - drawHeight) / 2 + settings.yPos * 5;

                ctx.drawImage(userImage, xOffset, yOffset, drawWidth, drawHeight);
            } else {
                ctx.fillStyle = '#eeeeee';
                ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
                ctx.fillStyle = '#999999';
                ctx.font = '24px Font2';
                ctx.textAlign = 'center';
                ctx.fillText('Upload an image to get started', CANVAS_WIDTH / 2, CANVAS_HEIGHT / 2);
            }

            // Draw template image on top
            if (templateImage) {
                ctx.drawImage(templateImage, 0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
            }

            // Set font for text overlay - using dynamic font color and custom size
            ctx.font = `${settings.textSize}pt CustomFont`;
            ctx.fillStyle = settings.fontColor || 'white'; // Default to white if not set
            ctx.textAlign = 'center';

            // Draw show name text with wrapping
            if (settings.showName) {
                const maxWidth = 800;
                const lineHeight = settings.textSize * 1.6;
                const centerY = 1100;
                const showNameUpperCase = settings.showName.toUpperCase();
                wrapText(ctx, showNameUpperCase, CANVAS_WIDTH / 2, centerY, maxWidth, lineHeight);
            }

            // Draw show date text
            if (settings.showDate) {
                const date = new Date(document.getElementById('showDate').value);
                const timeOptions = { hour: 'numeric', hour12: true };
                const time = date.toLocaleTimeString('en-US', timeOptions).toLowerCase();
                const dayName = date.toLocaleDateString('en-US', { weekday: 'long' }).toLowerCase();
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = String(date.getFullYear()).slice(-2);
                const formattedDate = `${day}.${month}.${year}`;

                const rightMargin = 50;
                const timeX = CANVAS_WIDTH - rightMargin;
                const timeY = 1191;
                const dayNameX = CANVAS_WIDTH - rightMargin;
                const dayNameY = timeY + 42;
                const dateX = CANVAS_WIDTH - rightMargin;
                const dateY = dayNameY + 42;

                ctx.font = `28pt Font2`;
                ctx.fillStyle = settings.fontColor || 'white'; // Default to white if not set
                ctx.textAlign = 'right';

                ctx.fillText(time, timeX, timeY);
                ctx.fillText(dayName, dayNameX, dayNameY);
                ctx.fillText(formattedDate, dateX, dateY);
            }

            // Draw tags
            const leftMargin = 30;
            const tagXOffset = 12; // Horizontal offset for tags
            const tagY = 1200; // Base Y position for Tag 1
            const tagSpacing = 60; // Vertical spacing between tags

            if (settings.tag1) {
                drawTagBox(settings.tag1, leftMargin + tagXOffset, tagY); // Draw Tag 1
            }

            if (settings.tag2) {
                const tag2Y = tagY + tagSpacing; // Position Tag 2 below Tag 1
                drawTagBox(settings.tag2, leftMargin + tagXOffset, tag2Y); // Draw Tag 2
            }
        }

        // Function to wrap text
        function wrapText(context, text, x, y, maxWidth, lineHeight) {
            const words = text.split(' ');
            let line = '';
            let yPos = y;

            for (let i = 0; i < words.length; i++) {
                const testLine = line + words[i] + ' ';
                const metrics = context.measureText(testLine);
                const testWidth = metrics.width;
                
                if (testWidth > maxWidth && i > 0) {
                    context.fillText(line, x, yPos);
                    line = words[i] + ' ';
                    yPos += lineHeight;
                } else {
                    line = testLine;
                }
            }
            
            context.fillText(line, x, yPos);
        }

        // Adjust canvas size when window is resized
        window.addEventListener('resize', function() {
            // We maintain the aspect ratio but scale down the preview if needed
            redrawCanvas();
        });

        // Initialize the canvas with a placeholder
        function initializeCanvas() {
            ctx.fillStyle = '#eeeeee';
            ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
            ctx.fillStyle = '#999999';
            ctx.font = '24px Font2';
            ctx.textAlign = 'center';
            ctx.fillText('Upload an image to get started', CANVAS_WIDTH / 2, CANVAS_HEIGHT / 2);

            // Ensure the text size is applied during initialization
            document.getElementById('textSizeSlider').value = settings.textSize;
            document.getElementById('textSizeValue').textContent = settings.textSize + 'pt';
            redrawCanvas(); // Redraw the canvas with the correct font size
        }

        // Initialize the canvas when the page loads
        initializeCanvas();
        
        // Initialize the filename with current date
        updateFileName();
        
        // ---- Add drag functionality for image positioning ----
        
        // Variables to track dragging state
        let isDragging = false;
        let lastMouseX = 0;
        let lastMouseY = 0;
        
        // Get the actual display size of the canvas to calculate the scaling factor
        function getCanvasScaleFactor() {
            const displayedWidth = canvas.clientWidth;
            const actualWidth = canvas.width;
            return actualWidth / displayedWidth;
        }
        
        // Mouse down event - start dragging
        canvas.addEventListener('mousedown', function(e) {
            if (!userImage) return; // Only allow dragging if there's an image
            
            isDragging = true;
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
            
            // Change cursor to indicate grabbing
            canvas.style.cursor = 'grabbing';
        });
        
        // Mouse move event - update position while dragging
        window.addEventListener('mousemove', function(e) {
            if (!isDragging) return;
            
            // Calculate the movement delta
            const deltaX = e.clientX - lastMouseX;
            const deltaY = e.clientY - lastMouseY;
            
            // Get scaling factor to adjust mouse movement to canvas coordinates
            const scaleFactor = getCanvasScaleFactor();
            
            // Update the position with scaled movement
            settings.xPos += deltaX / scaleFactor; // Remove inversion
            settings.yPos += deltaY / scaleFactor; // Remove inversion
            
            // Clamp position values
            settings.xPos = Math.max(-100, Math.min(100, settings.xPos));
            settings.yPos = Math.max(-100, Math.min(100, settings.yPos));
            
            // Update sliders
            document.getElementById('xPosSlider').value = settings.xPos;
            document.getElementById('yPosSlider').value = settings.yPos;
            document.getElementById('xPosValue').textContent = Math.round(settings.xPos);
            document.getElementById('yPosValue').textContent = Math.round(settings.yPos);
            
            // Redraw canvas with new position
            redrawCanvas();
            
            // Update last position
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
        });
        
        // Mouse up event - stop dragging
        window.addEventListener('mouseup', function() {
            if (isDragging) {
                isDragging = false;
                canvas.style.cursor = 'move';
            }
        });
        
        // Mouse leave event - stop dragging if cursor leaves the window
        window.addEventListener('mouseleave', function() {
            if (isDragging) {
                isDragging = false;
                canvas.style.cursor = 'move';
            }
        });

        // Helper function to get ordinal suffix (1st, 2nd, 3rd, etc.)
        function getOrdinalSuffix(day) {
            if (day > 3 && day < 21) return 'th';
            switch (day % 10) {
                case 1: return 'st';
                case 2: return 'nd';
                case 3: return 'rd';
                default: return 'th';
            }
        }
    </script>
</body>
</html>